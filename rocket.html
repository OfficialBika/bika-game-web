<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>BIKA ROCKET</title>
  <meta name="theme-color" content="#0b0f1d"/>
  <style>
    :root{
      --bg:#0b0f1d;
      --card: rgba(20,26,44,.70);
      --stroke: rgba(255,255,255,.10);
      --muted: rgba(220,230,255,.70);
      --txt: rgba(240,245,255,.96);
      --blue:#1e90ff;
      --green:#30e59f;
      --red:#ff4b6e;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1100px 700px at 50% 20%, rgba(80,120,255,.14), transparent 60%),
                  radial-gradient(900px 600px at 70% 80%, rgba(60,240,160,.10), transparent 60%),
                  linear-gradient(180deg, #070a14, var(--bg));
      color:var(--txt);
      min-height:100vh;
      padding:14px;
      overflow-x:hidden;
    }
    .wrap{max-width:520px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-radius:16px;background:rgba(0,0,0,.25);
      border:1px solid var(--stroke); box-shadow: var(--shadow); backdrop-filter: blur(10px);
    }
    .back{display:flex;align-items:center;gap:8px;color:var(--txt);text-decoration:none;font-weight:900}
    .titlePill{
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--stroke);
      font-weight:1000; letter-spacing:.2px;
    }
    .balPill{
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:16px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--stroke);
      font-weight:1000;
      min-width:140px; justify-content:flex-end;
    }
    .balPill small{color:var(--muted); font-weight:900}
    .card{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(25,33,60,.70), rgba(10,14,30,.55));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .stage{
      position:relative;
      height:330px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(600px 280px at 50% 75%, rgba(30,144,255,.14), transparent 60%);
    }
    canvas{position:absolute; inset:0;}
    .mult{
      position:absolute; top:86px; left:0; right:0;
      text-align:center;
      font-size: 64px;
      font-weight: 1100;
      letter-spacing: .5px;
      text-shadow: 0 20px 70px rgba(0,0,0,.55);
      pointer-events:none;
    }
    .mult.bet{opacity:.0}
    .countCircle{
      width:170px;height:170px;border-radius:999px;
      display:grid;place-items:center;
      border:10px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 0 0 6px rgba(0,0,0,.25);
      position:relative;
    }
    .countNum{font-size:62px;font-weight:1100}
    .countRing{
      position:absolute; inset:-10px;
      border-radius:999px;
      background: conic-gradient(from 270deg, rgba(255,165,0,.95) var(--p), rgba(255,255,255,.08) 0);
      mask: radial-gradient(farthest-side, transparent calc(100% - 20px), #000 0);
      -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 20px), #000 0);
      filter: drop-shadow(0 16px 40px rgba(0,0,0,.35));
    }

    .controls{padding:12px}
    .chips{display:flex;gap:8px;flex-wrap:nowrap;overflow:auto;padding-bottom:6px}
    .chip{
      flex:0 0 auto;
      padding:8px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-weight:1000;
    }
    .chip.active{border-color:rgba(30,144,255,.55); box-shadow:0 0 0 4px rgba(30,144,255,.16)}
    .btn{
      width:100%;
      margin-top:10px;
      padding:16px 14px;
      border-radius:18px;
      border:0;
      font-weight:1100;
      font-size:18px;
      letter-spacing:.2px;
      background: var(--blue);
      color:white;
      box-shadow: 0 18px 55px rgba(30,144,255,.25);
      cursor:pointer;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.cash{ background: linear-gradient(180deg, rgba(48,229,159,1), rgba(48,229,159,.85)); color:#052015; }
    .hint{color:var(--muted);font-size:12px;margin-top:8px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .list{padding:12px;display:flex;flex-direction:column;gap:10px}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
    }
    .left{display:flex;align-items:center;gap:10px;min-width:0}
    .av{width:42px;height:42px;border-radius:14px;background:rgba(255,255,255,.08);display:grid;place-items:center;font-weight:1100}
    .nm{min-width:0}
    .nm b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .nm small{color:var(--muted);font-weight:900}
    .pill{
      padding:8px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      font-weight:1100;
    }
    .win{border-color:rgba(48,229,159,.35); background:rgba(48,229,159,.10)}
    .lost{border-color:rgba(255,75,110,.35); background:rgba(255,75,110,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="back" href="./index.html">‚Üê Back</a>
      <div class="titlePill">üéÅ <span>BIKA ROCKET</span></div>
      <div class="balPill"><small>MMK</small> <span id="bal">‚Äî</span></div>
    </div>

    <div class="card">
      <div class="stage">
        <canvas id="c"></canvas>
        <div id="mult" class="mult bet">1.00√ó</div>

        <div id="countWrap" class="countCircle" style="--p:0deg;">
          <div class="countRing"></div>
          <div class="countNum" id="countNum">6</div>
        </div>
      </div>

      <div class="controls">
        <div class="chips" id="chips"></div>
        <button class="btn" id="mainBtn">Place bet</button>
        <div class="hint">
          <span id="phase">Phase: ‚Äî</span>
          <span id="note">Tip: Bet 20‚Äì1000</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="list" id="players"></div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const PROXY = "https://bika-web-proxy.dabllu2022.workers.dev";
  const USER_ID = localStorage.getItem("bika_userId") || "8251006975"; // MVP manual
  localStorage.setItem("bika_userId", USER_ID);
  const BETS = [20,50,100,200,500,1000];

  // ========= UI state =========
  let selectedBet = 100;
  let myHasBet = false;
  let lastRoundId = null;
  let phase = "BETTING";
  let currentMult = 1.00;

  // ========= canvas rocket anim =========
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  let W=0,H=0, DPR=1;

  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = canvas.width = Math.floor(canvas.clientWidth * DPR);
    H = canvas.height = Math.floor(canvas.clientHeight * DPR);
  }
  window.addEventListener("resize", resize);
  resize();

  let sparks = [];
  function addSparks(x,y,n=60){
    for(let i=0;i<n;i++){
      sparks.push({
        x,y,
        vx:(Math.random()*2-1)*3.2,
        vy:(Math.random()*2-1)*3.2,
        g:0.06+Math.random()*0.06,
        life:45+Math.random()*30
      });
    }
  }

  function bez2(a,c,b,t){ return (1-t)*(1-t)*a + 2*(1-t)*t*c + t*t*b; }
  function bez2d(a,c,b,t){ return 2*(1-t)*(c-a) + 2*t*(b-c); }

  function roundRect(x,y,w,h,r,fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill(); else ctx.stroke();
  }

  function drawRocket(x,y,ang){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(ang);
    ctx.shadowColor = "rgba(255,255,255,.35)";
    ctx.shadowBlur = 22*DPR;

    ctx.fillStyle = "rgba(120,210,255,.95)";
    roundRect(-18*DPR, -8*DPR, 42*DPR, 16*DPR, 8*DPR, true);

    ctx.fillStyle = "rgba(255,120,140,.95)";
    ctx.beginPath();
    ctx.moveTo(24*DPR, 0);
    ctx.lineTo(14*DPR, -8*DPR);
    ctx.lineTo(14*DPR, 8*DPR);
    ctx.closePath(); ctx.fill();

    ctx.fillStyle = "rgba(0,0,0,.45)";
    ctx.beginPath(); ctx.arc(4*DPR,0, 5*DPR,0,Math.PI*2); ctx.fill();

    if(phase==="FLYING"){
      ctx.shadowBlur = 0;
      ctx.fillStyle = "rgba(80,255,180,.92)";
      ctx.beginPath();
      ctx.moveTo(-18*DPR,0);
      ctx.quadraticCurveTo(-34*DPR, -8*DPR, -40*DPR, 0);
      ctx.quadraticCurveTo(-34*DPR, 8*DPR, -18*DPR, 0);
      ctx.fill();
    }
    ctx.restore();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    ctx.globalAlpha = 0.12;
    for(let i=0;i<22;i++){
      const x = (i*97 % W);
      const y = (i*173 % H);
      ctx.beginPath(); ctx.arc(x,y, 4*DPR, 0, Math.PI*2); ctx.fillStyle="#ffffff"; ctx.fill();
    }
    ctx.globalAlpha = 1;

    const t = phase === "FLYING" ? Math.min(1, (currentMult-1)/9) : 0;
    const x0 = 40*DPR, y0 = H*0.72;
    const x1 = W*0.74, y1 = H*0.24;
    const cx = W*0.35, cy = H*0.80;

    const rx = bez2(x0,cx,x1,t);
    const ry = bez2(y0,cy,y1,t);

    ctx.lineWidth = 10*DPR;
    ctx.lineCap = "round";
    const grad = ctx.createLinearGradient(x0,y0,rx,ry);
    grad.addColorStop(0, "rgba(140,90,255,.25)");
    grad.addColorStop(1, "rgba(140,90,255,.95)");
    ctx.strokeStyle = grad;
    ctx.beginPath();
    for(let s=0; s<=t; s+=0.02){
      const px = bez2(x0,cx,x1,s);
      const py = bez2(y0,cy,y1,s);
      if(s===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();

    const angle = Math.atan2(bez2d(y0,cy,y1,t), bez2d(x0,cx,x1,t));
    drawRocket(rx, ry, angle);

    sparks = sparks.filter(p => p.life>0);
    for(const p of sparks){
      p.vy += p.g*DPR;
      p.x += p.vx*DPR;
      p.y += p.vy*DPR;
      p.life -= 1;
      ctx.globalAlpha = Math.max(0, p.life/70);
      ctx.fillStyle = "rgba(255,255,255,1)";
      ctx.beginPath(); ctx.arc(p.x,p.y, 2.4*DPR, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);

  // ========= UI building =========
  const chipsEl = document.getElementById("chips");
  BETS.forEach(v=>{
    const b=document.createElement("div");
    b.className="chip"+(v===selectedBet?" active":"");
    b.textContent = v+" MMK";
    b.onclick=()=>{ selectedBet=v; [...chipsEl.children].forEach(c=>c.classList.remove("active")); b.classList.add("active"); };
    chipsEl.appendChild(b);
  });

  const btn = document.getElementById("mainBtn");
  const balEl = document.getElementById("bal");
  const phaseEl = document.getElementById("phase");
  const noteEl = document.getElementById("note");
  const multEl = document.getElementById("mult");
  const countWrap = document.getElementById("countWrap");
  const countNum = document.getElementById("countNum");

  function setBtn(mode){
    if(mode==="BET"){
      btn.className="btn";
      btn.textContent="Place bet";
      btn.disabled = false;
    } else if(mode==="CASH"){
      btn.className="btn cash";
      btn.textContent="Cash out";
      btn.disabled = !myHasBet;
    } else {
      btn.className="btn";
      btn.textContent="Waiting‚Ä¶";
      btn.disabled = true;
    }
  }

  // ========= API =========
  async function jget(path){
    const r = await fetch(PROXY + path, { method:"GET" });
    return r.json();
  }
  async function jpost(path, body){
    const r = await fetch(PROXY + path, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    return r.json();
  }

  // ========= Actions =========
  btn.onclick = async ()=>{
    try{
      if(phase==="BETTING"){
        const data = await jpost("/rocket/bet", { userId: USER_ID, amount: selectedBet });
        if(!data.ok){ noteEl.textContent = "Bet failed: " + (data.error||""); return; }
        myHasBet = true;
        noteEl.textContent = "Bet placed: "+selectedBet+" MMK";
      } else if(phase==="FLYING"){
        const data = await jpost("/rocket/cashout", { userId: USER_ID });
        if(!data.ok){ noteEl.textContent = "Cashout failed: " + (data.error||""); return; }
        noteEl.textContent = `Cashed out @ ${Number(data.cashoutMult).toFixed(2)}√ó ‚Ä¢ +${Number(data.payout||0).toLocaleString("en-US")} MMK`;
        setBtn("WAIT");
      }
    } catch(e){
      noteEl.textContent = "Network error";
    }
  };

  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  function renderPlayers(players){
    const box = document.getElementById("players");
    box.innerHTML="";
    if(!players || !players.length){
      box.innerHTML = `<div style="padding:12px;color:rgba(220,230,255,.7);font-weight:900;">No bets yet.</div>`;
      return;
    }
    players.slice(0,12).forEach(p=>{
      const name = p.username ? "@"+p.username : (p.firstName || ("ID "+p.userId));
      const sub = `${Number(p.amount||0).toLocaleString("en-US")} MMK ‚Ä¢ ${p.cashoutMult ? (Number(p.cashoutMult).toFixed(2)+"√ó") : "‚Äî"}`;
      const right = p.payout ? (Number(p.payout).toLocaleString("en-US")+" MMK") : (Number(p.amount||0).toLocaleString("en-US")+" MMK");
      const cls = p.payout ? "win" : (phase==="CRASHED" ? "lost" : "");
      const row = document.createElement("div");
      row.className="row "+cls;
      row.innerHTML = `
        <div class="left">
          <div class="av">‚óÜ</div>
          <div class="nm"><b>${escapeHtml(name)}</b><small>${escapeHtml(sub)}</small></div>
        </div>
        <div class="pill">${escapeHtml(right)}</div>
      `;
      box.appendChild(row);
    });
  }

  // ========= Poll loop =========
  async function tick(){
    try{
      // balance via proxy /balance
      const b = await jget("/balance?userId="+encodeURIComponent(USER_ID));
      if(b?.ok){
        const rawBal = (b.balance ?? b.data?.balance ?? 0);
        balEl.textContent = Number(rawBal||0).toLocaleString("en-US");
      }

      const s = await jget("/rocket/state");
      if(!s?.ok) throw new Error("state");

      if(lastRoundId && s.id !== lastRoundId){
        myHasBet = false;
        setBtn("BET");
      }
      lastRoundId = s.id;
      phase = s.phase;

      if(phase==="BETTING"){
        multEl.classList.add("bet");
        const left = Math.max(0, s.countdownLeftMs||0);
        const sec = Math.ceil(left/1000);
        countNum.textContent = String(sec);
        const prog = 1 - (left / 6000);
        const deg = Math.max(0, Math.min(360, prog*360));
        countWrap.style.setProperty("--p", deg+"deg");
        countWrap.style.display = "grid";

        phaseEl.textContent = "Phase: BETTING";
        setBtn("BET");
        noteEl.textContent = myHasBet ? "Bet placed. Waiting rocket‚Ä¶" : "Choose amount, then Place bet";
        currentMult = 1.00;
      }

      if(phase==="FLYING"){
        countWrap.style.display = "none";
        multEl.classList.remove("bet");
        currentMult = Number(s.currentMult||1);
        multEl.textContent = currentMult.toFixed(2) + "√ó";
        phaseEl.textContent = "Phase: FLYING";
        setBtn("CASH");
        noteEl.textContent = myHasBet ? "Cash out anytime ‚Äî rocket keeps running" : "No bet this round";
      }

      if(phase==="CRASHED"){
        countWrap.style.display = "none";
        multEl.classList.remove("bet");
        multEl.textContent = (Number(s.crashMult||1).toFixed(2)) + "√ó";
        phaseEl.textContent = "Phase: CRASHED";
        setBtn("WAIT");
        addSparks(W*0.62, H*0.34, 140);
        noteEl.textContent = "CRASH! next round soon‚Ä¶";
      }

      const p = await jget("/rocket/players");
      if(p?.ok) renderPlayers(p.players);

    } catch(e){
      phaseEl.textContent = "Phase: OFFLINE";
      noteEl.textContent = "Failed to fetch";
      setBtn("WAIT");
    } finally {
      setTimeout(tick, 1200);
    }
  }
  tick();
</script>
</body>
</html>
